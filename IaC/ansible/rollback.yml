# rollback.yml
- name: Rollback AWS Infrastructure
  hosts: localhost
  gather_facts: no

  tasks:
    - name: Load network configuration variables
      include_vars:
        file: network_config.yml
  
    - name: Load Instances configuration variables
      include_vars:
        file: instances_config.yml

    - name: Terminate WebServer Instance
      amazon.aws.ec2_instance:
        state: absent  
        wait: yes
        instance_ids:
          - "{{ ec2_webserver_ids }}"
      register: webserver_terminated

    - name: Terminate DBServer Instance
      amazon.aws.ec2_instance:
        state: absent  
        wait: yes
        instance_ids:
          - "{{ ec2_dbserver_ids }}"
      register: dbserver_terminated

    - name: Terminate SSH Server Instance
      amazon.aws.ec2_instance:
        state: absent 
        wait: yes
        instance_ids:
          - "{{ ec2_sshserver_ids }}"
      register: sshserver_terminated

    - name: Wait for Instances to Terminate Completely
      amazon.aws.ec2_instance_info:
        instance_ids:
          - "{{ ec2_webserver_ids }}"
          - "{{ ec2_dbserver_ids }}"
          - "{{ ec2_sshserver_ids }}"
      register: instances_check
      until: instances_check.instances | length == 0
      retries: 10
      delay: 15

    - name: Remove VPC if no instances remain (conditional rollback)
      amazon.aws.ec2_vpc_net:
        vpc_id: "{{ vpc_id }}"
        state: absent
      when: instances_check.instances | length == 0
      tagg: RemoveVPC
